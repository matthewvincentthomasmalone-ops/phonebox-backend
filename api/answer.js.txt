const twilio = require("twilio");

function withCors(res) {
  res.setHeader("Access-Control-Allow-Origin", "*");
  res.setHeader("Access-Control-Allow-Methods", "POST,OPTIONS");
  res.setHeader("Access-Control-Allow-Headers", "Content-Type");
}

module.exports = async (req, res) => {
  withCors(res);

  if (req.method === "OPTIONS") {
    res.statusCode = 204;
    res.end();
    return;
  }
  if (req.method !== "POST") {
    res.statusCode = 405;
    res.setHeader("Content-Type", "application/json");
    res.end(JSON.stringify({ ok: false, error: "Method Not Allowed" }));
    return;
  }

  global.__PHONEBOX__ = global.__PHONEBOX__ || { activeByEndpoint: new Map() };

  // Read JSON body
  const buffers = [];
  for await (const chunk of req) buffers.push(chunk);
  const bodyRaw = Buffer.concat(buffers).toString("utf8");
  const body = bodyRaw ? JSON.parse(bodyRaw) : {};

  const endpointNumber = body.endpointNumber;
  const callSidFromClient = body.callSid;

  let callSid = callSidFromClient;
  if (!callSid && endpointNumber) {
    const active = global.__PHONEBOX__.activeByEndpoint.get(endpointNumber);
    callSid = active && active.callSid;
  }

  if (!callSid) {
    res.statusCode = 400;
    res.setHeader("Content-Type", "application/json");
    res.end(
      JSON.stringify({
        ok: false,
        error: "Missing callSid (or no active call found for endpointNumber).",
      })
    );
    return;
  }

  const accountSid = process.env.TWILIO_ACCOUNT_SID;
  const authToken = process.env.TWILIO_AUTH_TOKEN;
  if (!accountSid || !authToken) {
    res.statusCode = 500;
    res.setHeader("Content-Type", "application/json");
    res.end(JSON.stringify({ ok: false, error: "Twilio env vars not set." }));
    return;
  }

  const client = twilio(accountSid, authToken);

  const host = req.headers["x-forwarded-host"] || req.headers.host;
  const proto = (req.headers["x-forwarded-proto"] || "https").toString();
  const baseUrl = `${proto}://${host}`;

  const playUrl = `${baseUrl}/api/play?endpointNumber=${encodeURIComponent(
    endpointNumber || ""
  )}`;

  try {
    await client.calls(callSid).update({ url: playUrl, method: "POST" });

    if (endpointNumber) global.__PHONEBOX__.activeByEndpoint.delete(endpointNumber);

    res.statusCode = 200;
    res.setHeader("Content-Type", "application/json");
    res.end(JSON.stringify({ ok: true, callSid, playUrl }));
  } catch (err) {
    res.statusCode = 500;
    res.setHeader("Content-Type", "application/json");
    res.end(JSON.stringify({ ok: false, error: err.message || String(err) }));
  }
};